name: Debian Packaging for Python Packages

on:
  push:
    branches:
      - master
  workflow_dispatch:
    branches:
      - master
  schedule:
    # Run daily at midnight
    - cron:  '0 0 * * *'

env:
  DEB_BUILD_DOCKER_IMAGE: "pitop/pi-top-os-deb-build"
  DEB_BUILD_DOCKER_TAG: "bullseye-master"
  CHANGELOG_AUTHOR_NAME: "pi-top"
  CHANGELOG_AUTHOR_EMAIL: "deb-maintainers@pi-top.com"
  PACKAGECLOUD_REPO: "experimental"
  OS: "debian"
  DISTRO: "bullseye"
  ARCH: "linux/arm/v7"

jobs:
  build-debian-package:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        # Also "dlib" and "onnxruntime"
        # --> preferably get from wheel

        # TODO: fix "python-sonic" requiring "python-osc"
        package: ["imutils", "pynput", "python-sonic", "PyV4L2Camera"]
    steps:
      - name: Install stdeb
        run: |
          pip install stdeb

          mkdir -p ${{ github.workspace }}/.tmp

      - name: Download source
        run: |
          cd ${{ github.workspace }}/.tmp
          pypi-download ${{ matrix.package }}
          tar xvzf *${{ matrix.package }}*.tar.gz
          rm *${{ matrix.package }}*.tar.gz

      # https://github.com/gkvoelkl/python-sonic/pull/32
      - name: Fix python-sonic source
        if: matrix.package == 'python-sonic'
        run: |
          cd ${{ github.workspace }}/.tmp/${{ matrix.package }}-*
          sed -i "s/README.txt/README.rst/1" setup.py
          sed -i "/pytest-runner/d" setup.py

      - name: Move files to workspace
        run: |
          cd ${{ github.workspace }}/.tmp/${{ matrix.package }}-*
          mv * ${{ github.workspace }}
          cd ${{ github.workspace }}

      - name: Create ARM Docker container
        run: |
          docker create \
            --name container \
            --volume ${{ github.workspace }}:${{ github.workspace }} \
            --workdir=${{ github.workspace }} \
            --tty \
            --platform ${{ env.ARCH }} \
            ${{ env.OS }}:${{ env.DISTRO }} \
            sleep inf

      - name: Start ARM Docker container
        run: |
          docker start container

      - name: ARM Docker container - install system dependencies
        run: |
          docker exec container \
            apt-get update && \
            apt-get install -y \
              debhelper \
              dh-python \
              dh-virtualenv \
              libv4l-dev \
              python3-all-dev \
              python3-pip \
              python3-virtualenv

      - name: ARM Docker container - install stded
        run: |
          docker exec container \
            pip3 install stdeb

      - name: ARM Docker container - build deb package
        run: |
          docker exec container \
            python3 setup.py \
              --command-packages=stdeb.command \
              sdist_dsc --with-python2=False --with-python3=True \
              bdist_deb

      - run: mv deb_dist artifacts

      - name: Generate artifact name
        run: |
          echo "ARTIFACT_PREFIX=$(basename -s .dsc "$(find . -name "*.dsc")")" >> $GITHUB_ENV

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.ARTIFACT_PREFIX }}.deb
          path: ./artifacts/*.deb

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.ARTIFACT_PREFIX }}.deb-src
          path: ./artifacts/*.tar.xz

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.ARTIFACT_PREFIX }}.metadata
          path: |
            ./artifacts/**
            !./artifacts/*.deb
            !./artifacts/*.tar.xz

      # Upload experimental build
      - uses: docker://lpenz/ghaction-packagecloud:v0.3
        with:
          repository: ${{ env.PACKAGECLOUD_REPO }}/${{ env.OS }}/${{ env.DISTRO }}
        env:
          PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_TOKEN }}
          files: ./deb/*.dsc
